AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS STEM Workshop Session 2 - School Guide Chatbot with Lambda Function URL'

Parameters:
  S3BucketName:
    Type: String
    Description: Name for the S3 bucket (must be globally unique)
    Default: school-guide-chatbot

  AgentName:
    Type: String
    Description: Name for the Bedrock Agent
    Default: SchoolGuideAgent

Resources:
  # ==========================================
  # S3 Bucket for Knowledge Base
  # ==========================================
  SchoolDocumentsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${S3BucketName}-${AWS::AccountId}"
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256

  # ==========================================
  # Bedrock Agent IAM Role
  # ==========================================
  BedrockIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - bedrock.amazonaws.com
          Action:
          - 'sts:AssumeRole'
      Policies:
      - PolicyName: BedrockIamPolicy
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: Allow
            Action:
            - bedrock:*
            Resource: '*'
      RoleName: BedrockIamRole

  # ==========================================
  # Lambda Execution Role (Agent Invoker)
  # ==========================================
  AgentInvokerLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      - arn:aws:iam::aws:policy/AmazonBedrockFullAccess

  # ==========================================
  # Lambda Function (Agent Invoker for Web App)
  # ==========================================
  AgentInvokerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: school-chatbot-agent-invoker
      Handler: index.lambda_handler
      Role: !GetAtt AgentInvokerLambdaRole.Arn
      Runtime: python3.11
      Timeout: 60
      MemorySize: 128
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          from datetime import datetime

          def lambda_handler(event, context):
              # CORS Preflight
              request_context = event.get('requestContext', {})
              http_method = request_context.get('http', {}).get('method', event.get('httpMethod', ''))
              
              # Lambda Function URL handles CORS automatically, no need to handle OPTIONS
              if http_method == 'OPTIONS':
                  return {
                      'statusCode': 200,
                      'body': ''
                  }
              
              try:
                  # Parse body
                  body_str = event.get('body', '{}')
                  if isinstance(body_str, str):
                      body = json.loads(body_str)
                  else:
                      body = body_str
                  
                  agent_id = body.get('agentId')
                  agent_alias_id = body.get('agentAliasId', 'TSTALIASID')
                  session_id = body.get('sessionId', 'default-session')
                  user_input = body.get('input', '')
                  
                  if not agent_id or not user_input:
                      return {
                          'statusCode': 400,
                          'body': json.dumps({
                              'error': 'agentId and input are required.'
                          })
                      }
                  
                  print(f"Invoking Agent: {agent_id} with input: {user_input}")
                  
                  # Bedrock Agent invocation
                  bedrock_agent_runtime = boto3.client('bedrock-agent-runtime')
                  response = bedrock_agent_runtime.invoke_agent(
                      agentId=agent_id,
                      agentAliasId=agent_alias_id,
                      sessionId=session_id,
                      inputText=user_input
                  )
                  
                  # Stream response processing
                  output_text = ""
                  for event_stream in response.get('completion', []):
                      if 'chunk' in event_stream:
                          chunk = event_stream['chunk']
                          if 'bytes' in chunk:
                              output_text += chunk['bytes'].decode('utf-8')
                  
                  return {
                      'statusCode': 200,
                      'headers': {
                          'Content-Type': 'application/json'
                      },
                      'body': json.dumps({
                          'response': output_text,
                          'timestamp': datetime.now().isoformat()
                      }, ensure_ascii=False)
                  }
                  
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps({
                          'error': f'Agent invocation failed: {str(e)}'
                      }, ensure_ascii=False)
                  }

  # ==========================================
  # Lambda Function URL
  # ==========================================
  LambdaFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      TargetFunctionArn: !GetAtt AgentInvokerFunction.Arn
      Cors:
        AllowCredentials: false
        AllowOrigins:
          - '*'
        AllowMethods:
          - POST
          - GET
        AllowHeaders:
          - '*'
        ExposeHeaders:
          - '*'
        MaxAge: 86400

  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AgentInvokerFunction
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
      FunctionUrlAuthType: NONE

  # ==========================================
  # Bedrock Agent
  # ==========================================
  SchoolGuideAgent:
    Type: AWS::Bedrock::Agent
    Properties:
      AgentName: !Ref AgentName
      AgentResourceRoleArn: !GetAtt BedrockIamRole.Arn
      FoundationModel: !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/us.amazon.nova-pro-v1:0"
      Instruction: |
        ë‹¹ì‹ ì€ ì„œìš¸ê¸ˆìœµê³ ë“±í•™êµ ì†Œí”„íŠ¸ì›¨ì–´ê³¼ì˜ ì•ˆë‚´ ë„ìš°ë¯¸ AIì…ë‹ˆë‹¤.  
        í•™êµì— ê´€ì‹¬ ìˆëŠ” í•™ìƒê³¼ í•™ë¶€ëª¨ì—ê²Œ ì†Œí”„íŠ¸ì›¨ì–´ê³¼ì˜ êµìœ¡ê³¼ì •, ìê²©ì¦, ì§„ë¡œ, ì‚°í•™ì—°ê³„ í”„ë¡œê·¸ë¨ ë“±ì„ ì¹œì ˆí•˜ê²Œ ì•ˆë‚´í•©ë‹ˆë‹¤.

        ğŸ’¬ ëŒ€í™” ì‹œì‘
        ì²˜ìŒ ì¸ì‚¬í•  ë•Œ ì´ë ‡ê²Œ ë§í•˜ì„¸ìš”:
        â€œì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì„œìš¸ê¸ˆìœµê³ ë“±í•™êµ ì†Œí”„íŠ¸ì›¨ì–´ê³¼ ì•ˆë‚´ ë„ìš°ë¯¸ì˜ˆìš” ğŸ˜Š  
        í•™êµë‚˜ í•™ê³¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë³´ì„¸ìš”!  
        ì˜ˆë¥¼ ë“¤ì–´ â€˜ì†Œí”„íŠ¸ì›¨ì–´ê³¼ì—ì„œëŠ” ì–´ë–¤ ê±¸ ë°°ìš°ë‚˜ìš”?â€™ë‚˜ â€˜ì–´ë–¤ ìê²©ì¦ì„ ì·¨ë“í•  ìˆ˜ ìˆë‚˜ìš”?â€™ì²˜ëŸ¼ìš”.â€

        ğŸ¯ ì—­í• 
        - ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì—°ê²°ëœ ì§€ì‹ ê¸°ë°˜(PDF ë¬¸ì„œ)ì„ ì°¸ê³ í•˜ì—¬ ì •í™•í•˜ê²Œ ì•ˆë‚´í•©ë‹ˆë‹¤.  
        - ë‹¨ìˆœí•œ ì •ë³´ ë‚˜ì—´ì´ ì•„ë‹ˆë¼, í•™ìƒì´ ì´í•´í•˜ê¸° ì‰¬ìš´ ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.  
        - ì •ë³´ê°€ ëª…í™•í•˜ì§€ ì•Šê±°ë‚˜ ë¬¸ì„œì— ì—†ëŠ” ë‚´ìš©ì€ â€œì •í™•í•œ ì •ë³´ëŠ” í•™êµì— ì§ì ‘ ë¬¸ì˜í•´ì£¼ì„¸ìš”.â€ë¼ê³  ë‹µë³€í•©ë‹ˆë‹¤.

        ğŸ—£ï¸ ë§íˆ¬ & ìŠ¤íƒ€ì¼
        - ìì—°ìŠ¤ëŸ½ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ, ì¹œê·¼í•œ ì„ ë°°ë‚˜ ì„ ìƒë‹˜ì²˜ëŸ¼ ëŒ€í™”í•˜ì„¸ìš”.  
        - ë¬¸ì¥ì€ ì§§ê³  ëª…í™•í•˜ê²Œ, ë„ˆë¬´ í˜•ì‹ì ì´ê±°ë‚˜ ë”±ë”±í•˜ì§€ ì•Šê²Œ ë§í•©ë‹ˆë‹¤.  
        - í•­ìƒ í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•˜ê³ , ì‚¬ìš©ìê°€ ì˜ì–´ë¡œ ì§ˆë¬¸í•´ë„ í•œêµ­ì–´ë¡œ ëŒ€ë‹µí•©ë‹ˆë‹¤.

        ğŸ“˜ ë‹µë³€ ê°€ì´ë“œ
        1. í•™êµ ì†Œê°œ, êµìœ¡ê³¼ì •, ìê²©ì¦, ì§„ë¡œ, ì‚°í•™ì—°ê³„ í”„ë¡œê·¸ë¨ ë“± í•™êµ ê´€ë ¨ ì •ë³´ëŠ”  
          ë°˜ë“œì‹œ ì§€ì‹ ê¸°ë°˜ ë‚´ìš©ì„ ìš°ì„  ì°¸ê³ í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤.  
        2. ì§ˆë¬¸ì´ ë¶ˆëª…í™•í•˜ë©´  
          â€œë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?â€ ë˜ëŠ”  
          â€œì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í•´ì£¼ì‹œë©´ ë” ì˜ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ìš”.â€ë¼ê³  ì•ˆë‚´í•©ë‹ˆë‹¤.  
        3. í•™ìƒì´ ë” ì•Œê³  ì‹¶ì–´ í•˜ë©´ ê°„ë‹¨í•œ ì¶”ê°€ ì„¤ëª…ì„ ë§ë¶™ì…ë‹ˆë‹¤.  
        4. ë¶ˆí•„ìš”í•˜ê²Œ ê¸´ ì„¤ëª…ì€ í”¼í•˜ê³ , í•µì‹¬ ë‚´ìš© ì¤‘ì‹¬ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.

        ğŸ“ ì˜ˆì‹œ í†¤
        - â€œì†Œí”„íŠ¸ì›¨ì–´ê³¼ëŠ” ì½”ë”©ê³¼ ì¸ê³µì§€ëŠ¥ì„ ë°°ìš°ëŠ” í•™ê³¼ì˜ˆìš”.  
          1í•™ë…„ì—” ê¸°ë³¸ í”„ë¡œê·¸ë˜ë°, 2~3í•™ë…„ì—” í”„ë¡œì íŠ¸ ì¤‘ì‹¬ ìˆ˜ì—…ì„ ì§„í–‰í•´ìš”.â€  
        - â€œì •ë³´ì²˜ë¦¬ê¸°ëŠ¥ì‚¬, ë„¤íŠ¸ì›Œí¬ê´€ë¦¬ì‚¬ ê°™ì€ ìê²©ì¦ì„ ì·¨ë“í•  ìˆ˜ ìˆì–´ìš”.â€  
        - â€œì •í™•í•œ ì¼ì •ì€ í•™êµ í™ˆí˜ì´ì§€ë¥¼ ì°¸ê³ í•´ì£¼ì‹œë©´ ì¢‹ì•„ìš”.â€
      IdleSessionTTLInSeconds: 1800
      AutoPrepare: true

# ==========================================
# Outputs
# ==========================================
Outputs:
  AgentId:
    Description: 'Agent ID - Copy this for Step 5 (Amplify web app setup)'
    Value: !Ref SchoolGuideAgent

  ApiEndpoint:
    Description: 'Lambda Function URL - Copy this for Step 5 (Amplify web app setup)'
    Value: !GetAtt LambdaFunctionUrl.FunctionUrl

  Region:
    Description: 'Deployed Region'
    Value: !Ref AWS::Region